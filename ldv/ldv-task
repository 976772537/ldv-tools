#!/bin/sh

#
#
# ldv-task --driver= --workdir=workdir --env=kernel_id(rule,rule):kernel_id(rule,rule,...)...
#
#
LOG_PREFIX="ldv-task: ";
ldv_print() {
	if [ $LDV_DEBUG -le 0 ]; then if [ -n "`echo $1 | grep WARNING`" -o -n "`echo $1 | grep NORMAL`" -o -n "`echo $1 | grep INFO`" -o -n "`echo $1 | grep DEBUG`" -o -n "`echo $1 | grep TRACE`" -o -n "`echo $1 | grep ALL`" ]; then return; fi;
	elif [ $LDV_DEBUG -le 10 ]; then if [ -n "`echo $1 | grep INFO`" -o -n "`echo $1 | grep DEBUG`" -o -n "`echo $1 | grep TRACE`" -o -n "`echo $1 | grep ALL`" ]; then return; fi;
	elif [ $LDV_DEBUG -le 20 ]; then if [ -n "`echo $1 | grep DEBUG`" -o -n "`echo $1 | grep TRACE`" -o -n "`echo $1 | grep ALL`" ]; then return; fi;
	elif [ $LDV_DEBUG -le 30 ]; then if [ -n "`echo $1 | grep TRACE`" -o -n "`echo $1 | grep ALL`" ]; then return; fi;
	elif [ $LDV_DEBUG -le 40 ]; then if [ -n "`echo $1 | grep ALL`" ]; then return; fi; fi;
	if [ $LDV_DEBUG -eq 40 ]; then 
		echo $LOG_PREFIX"TRACE: Trace mode on. Press any key to continue...";
		read;
	fi;
	echo "$LOG_PREFIX$1";
}
if [ ! -n "$LDV_DEBUG" ]; then LDV_DEBUG=10; fi;


LDV_HOME=`readlink -f \`dirname $0\`/../`;
LDV_DIR=$LDV_HOME/ldv;
LDV_KMANAGER=$LDV_DIR/ldv-kmanager;
LDV_CORE_DIR=$LDV_HOME/ldv-core;
LDV_CORE_EXEC=$LDV_CORE_DIR/ldv-core;

KERNEL_LEVEL=0;

#
# scan and test command line parameters
#
print_usage_and_exit() {
		ldv_print "NORMAL: USAGE: LDV_DEBUG=level WORK_DIR=workdir ldv-task --driver=driverpath --env=...";
		exit 1;
}
for arg in $@; do
        case $arg in
                --workdir=*)
                	rworkdir=`echo $arg | sed 's/--workdir=//g'`
			if [ ! -n "$rworkdir" ]; then
				ldv_print "ERROR: Parameter \"--workdir\" - is null. Setup it.";
			        exit 1;
			fi;
			echo "readlink -f $rworkdir";
			workdir=`readlink -f $rworkdir`;
			echo $workdir;
			if [ $? -ne 0 ]; then
				ldv_print "ERROR: Failed to read abs-path for working dir: \"$rworkdir\"."
			        exit 1;
			fi;
			if [ ! -d "$workdir" ]; then
			        ldv_print "ERROR: Environment dir not exists: \"$workdir\".";
			        exit 1;
			fi;
		;;
                --env=*)
                	env=`echo $arg | sed 's/--env=//g'`
                ;;
                --driver=*)
                	rdriver=`echo $arg | sed 's/--driver=//g'`
			if [ ! -n "$rdriver" ]; then
				ldv_print "ERROR: Parameter \"--driver\" - is null. Setup it.";
			        exit 1;
			fi;
			driver=`readlink -f $rdriver`;
			if [ $? -ne 0 ]; then
				ldv_print "ERROR: Failed to read abs-path for driver source: \"$rdriver\"."
				exit 1;
			fi;
			if [ ! -d "$driver" ]; then
			        ldv_print "ERROR: Driver unpacked sources not exists: \"$driver\".";
			        exit 1;
			fi;
		;;
 		--kernel-driver)
                	KERNEL_LEVEL=1;
                ;;
                *)
                        ldv_print "ERROR: Unknown options: '$arg'.";
			print_usage_and_exit;
                ;;
        esac
done

if [ ! -n "$env" ]; then
	ldv_print "ERROR: Parameter \"--env\" - is null. Setup it.";
        exit 1;
fi;
if [ ! -n "$driver" ]; then
	ldv_print "ERROR: Parameter \"--driver\" - is null. Setup it.";
        exit 1;
fi;
if [ ! -n "$workdir" ]; then
	ldv_print "ERROR: Parameter \"--workdir\" - is null. Setup it.";
        exit 1;
fi;



for i in `echo $env | sed 's/--env=//' | tr ':' ' '`; do
	WORK_DIR_LOCAL=$WORK_DIR_LOCAL/$k;
	mkdir $WORK_DIR_LOCAL;
	if [ $? -ne 0 ]; then
		ldv_print "ERROR: can not create environment-dir from task: \"$WORK_DIR_LOCAL\".";
		exit 1;
	fi;
	ENV_ID=`echo $i | sed 's/(.*)//'`;
	RULES=`echo $i | sed 's/.*(//'` |  sed 's/)//';
	KERNEL_PATH=`$LDV_KMANAGER getpath $ENV_ID`;
	if [ $? -ne 0 ]; then
		ldv_print "ERROR: ldv-kmanager return error for this environment: \"$KERNEL_PATH\".";
		exit 1;
	fi;
	ldv_print "NORMAL: Calling LDV-core.";
	if [ $KERNEL_LEVEL -eq 0 ]; then
		ldv_print "DEBUG: WORK_DIR=$WORK_DIR_LOCAL $LDV_CORE_EXEC --env=$KERNEL_PATH --driver=$DRIVER_ABS --rule-models=$rulemodels;";
		WORK_DIR=$WORK_DIR_LOCAL $LDV_CORE_EXEC --env=$KERNEL_PATH --driver=$DRIVER_ABS --rule-models=$rulemodels;
	else
		ldv_print "DEBUG: WORK_DIR=$WORK_DIR_LOCAL $LDV_CORE_EXEC --env=$KERNEL_PATH --driver-kernel --rule-models=$rulemodels;";
		WORK_DIR=$WORK_DIR_LOCAL $LDV_CORE_EXEC --env=$KERNEL_PATH --kernel-driver --rule-models=$rulemodels;
	fi;
	if [ $? -ne 0 ]; then
		ldv_print "ERROR: ldv-core failed.";
		exit 1;
	fi;
done;
exit;

ldv_print "INFO: temp workdir: $WORK_DIR";
# all temp dirs created... 
k=1;
tid=1;
for i in $@; do
	if [ $k -eq 1 ]; then
		k=`expr $k + 1`;
		continue;	
	elif [ -n "$USER_WORKDIR" -a $k -eq 2 ]; then 
		k=`expr $k + 1`;
		continue; 
	fi;
	ldv_print "INFO: $i";
	# create dir for this stage
	WORK_DIR_LOCAL=$WORK_DIR/$tid;
	mkdir $WORK_DIR_LOCAL;
	if [ $? -ne 0 ]; then
		ldv_print "ERROR: can not create environment-dir from task: \"$WORK_DIR_LOCAL\".";
		unset WORK_DIR_LOCAL;
		k=`expr $k + 1`;
		tid=`expr $tid + 1`;
		exit 1;
	fi;
	# get KERNELDIR for this environment;
	# kernel-manager return path if kernel-environment exists and correct prepared
	ENV_ID=`echo $i | sed 's/:.*//'`;
	rulemodels=`echo $i | sed 's/.*://'`;
	ldv_print "DEBUG: rulemodels: $rulemodels";
	if [ ! -n "$rulemodels" ]; then
		ldv_print "ERROR: rulemodels after \":\" is null. Please, setup it.";
		unset ENV_ID;
		unset KERNEL_PATH;
		unset WORK_DIR_LOCAL;
		k=`expr $k + 1`;
		tid=`expr $tid + 1`;
		exit 1;
	fi;
	ldv_print "INFO: env_id: $ENV_ID";
	ldv_print "INFO: workdir: $WORK_DIR_LOCAL";
	KERNEL_PATH=`$LDV_KMANAGER getpath $ENV_ID`;
	if [ $? -ne 0 ]; then
		ldv_print "ERROR: ldv-kmanager return error for this environment: \"$KERNEL_PATH\".";
		unset ENV_ID;
		unset KERNEL_PATH;
		unset WORK_DIR_LOCAL;
		k=`expr $k + 1`;
		tid=`expr $tid + 1`;
		exit 1;
	fi;
	ldv_print "NORMAL: Calling LDV-core.";
	if [ $KERNEL_LEVEL -eq 0 ]; then
		ldv_print "DEBUG: WORK_DIR=$WORK_DIR_LOCAL $LDV_CORE_EXEC --env=$KERNEL_PATH --driver=$DRIVER_ABS --rule-models=$rulemodels;";
		WORK_DIR=$WORK_DIR_LOCAL $LDV_CORE_EXEC --env=$KERNEL_PATH --driver=$DRIVER_ABS --rule-models=$rulemodels;
	else
		ldv_print "DEBUG: WORK_DIR=$WORK_DIR_LOCAL $LDV_CORE_EXEC --env=$KERNEL_PATH --driver-kernel --rule-models=$rulemodels;";
		WORK_DIR=$WORK_DIR_LOCAL $LDV_CORE_EXEC --env=$KERNEL_PATH --kernel-driver --rule-models=$rulemodels;
	fi;

	if [ $? -ne 0 ]; then
		ldv_print "ERROR: ldv-core failed.";
	fi;
	unset ENV_ID;
	unset KERNEL_PATH;
	unset WORK_DIR_LOCAL;
	k=`expr $k + 1`;
	tid=`expr $tid + 1`;
done;




